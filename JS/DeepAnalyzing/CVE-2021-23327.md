**Project**: Apexcharts

**Version**: 3.23.1

**Vulnerability Type**: Cross-site Scripting (XSS)

**Vulnerability Description**: The package apexcharts before 3.24.0 are vulnerable to Cross-site Scripting (XSS) via lack of sanitization of graph legend fields.

**Vulnerability Patch**: [Merge pull request #2158 from 418sec/1-npm-apexcharts Â· apexcharts/apexcharts.js@68f3f34 (github.com)](https://github.com/apexcharts/apexcharts.js/commit/68f3f34d125719b4767614fe0a595cc65bde1d19)

**Link to the vulnerable project**: [Release ðŸ’Ž Version 3.23.1 Â· apexcharts/apexcharts.js (github.com)](https://github.com/apexcharts/apexcharts.js/releases/tag/v3.23.1)

**Tools**

No one of the tools in the arsenal is able to detect the vulnerability. 

**Patterns**:

1. [Modules](https://github.com/enferas/TestabilityTarpits/tree/main/JS/TestabilityPatterns/87_modules)
2. [innertHTML](https://github.com/enferas/TestabilityTarpits/tree/main/JS/TestabilityPatterns/101_innerHTML_outerHTML)

**Explain code**:

The vulnerability path considers both the files **apexcharts.js** (render of HTML elements) and **Legend.js**. Since apexcharts is a node module to render graphs in HTML web pages, it requires an additional "glue code" to create an object ApexCharts and render a chart.

```js
//GLUE CODE:
var options = {
  chart: {
    type: 'bar'
  },
  series: [{
    name: 'labels',
    data: [30, 40, 45, 50, 49, 60, 70, 91, 125]
  }],
  xaxis: {
    categories: [1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999]
  }
}
var chart = new ApexCharts(document.querySelector('#chart'), options)
chart.render()

//in apexcharts.js
export default class ApexCharts {
  constructor(el, opts) {
    this.opts = opts
    this.ctx = this

    // Pass the user supplied options to the Base Class where these options will be extended with defaults. The returned object from Base Class will become the config object in the entire codebase.
    this.w = new Base(opts).init()

    this.el = el

    this.w.globals.cuid = Utils.randomId()
    this.w.globals.chartID = this.w.config.chart.id
      ? Utils.escapeString(this.w.config.chart.id)
      : this.w.globals.cuid

    const initCtx = new InitCtxVariables(this)
    initCtx.initModules()

    this.create = Utils.bind(this.create, this)
    this.windowResizeHandler = this._windowResizeHandler.bind(this)
    this.parentResizeHandler = this._parentResizeCallback.bind(this)
  }
    
// where Base and its init method are defined as follow in Base.js:
export default class Base {
  constructor(opts) {
    this.opts = opts
  }

  init() {
    const config = new Config(this.opts).init({ responsiveOverride: false })
    const globals = new Globals().init(config)

    const w = {
      config,
      globals
    }

    return w
  }
}

// in render() in apexcharts.js:
let graphData = this.create(this.w.config.series, {})

// in create:
this.legend.init()

//legend is a class and in init() method, in Legend.js:
this.drawLegends()
//drawLegends method:
drawLegends() {
    let self = this
    let w = this.w
	...
    let legendNames = w.globals.seriesNames
	let legendFormatter = w.globals.legendFormatter
	let text = legendFormatter(legendNames[i], { seriesIndex: i, w })
	elLegendText.innerHTML = Array.isArray(text) ? text.join(' ') : text //SINK
```

**Refactoring**:

- **Modules** (P87): The contents of imported JavaScript modules is copied where they are included. The transformation does not impact on the semantic of the code (**T1**).

```js
// Before:
import Legend from './legend/Legend'

// After:
//import Legend from './legend/Legend'
/*copy of the file ./legend/Legend here*/
```

- **innerHTML** (P101): a _document.write_ of the argument passed to _innerHTML_ assignment is written immediately after that line of code. This transformation changes the semantic of the code (**T2**). 

```js
// Before:
elLegendText.innerHTML = text.join(' ');

// After:
elLegendText.innerHTML = text.join(' ');
document.write(text.join(' '));
```

The tarpits transformations have been applied to all the project code. Once the modified version has been submitted to Comm_2, the CVE vulnerability has been identified, while a [new one](https://www.huntr.dev/bounties/2-other-apexcharts/apexcharts.js/) occurred (still under CVE assignment):

```js
// in Legend.js (original code):
if (w.config.legend.markers.customHTML) {
	if (Array.isArray(w.config.legend.markers.customHTML)) {
    	if (w.config.legend.markers.customHTML[i]) {
            elMarker.innerHTML = w.config.legend.markers.customHTML[i]()
         }
     } else {
     	elMarker.innerHTML = w.config.legend.markers.customHTML()
	}
}
```

