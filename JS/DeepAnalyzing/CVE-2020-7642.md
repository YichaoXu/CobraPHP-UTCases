**Project**: Lazysizes

**Version**: 5.2.0

**Vulnerability Type**: Cross-Site Scripting and Code Injection

**Vulnerability Description**: lazysizes through 5.2.0 allows execution of malicious JavaScript. The following attributes are not sanitized by the video-embed plugin: data-vimeo, data-vimeoparams, data-youtube and data-ytparams which can be abused to inject malicious JavaScript.

**Vulnerability Patch**: [Video embed: test yt/vimeo id (fixes #764) · aFarkas/lazysizes@3720ab8 (github.com)](https://github.com/aFarkas/lazysizes/commit/3720ab8262552d4e063a38d8492f9490a231fd48)

**Link to the vulnerable project**: [Release 5.2.0 · aFarkas/lazysizes (github.com)](https://github.com/aFarkas/lazysizes/releases/tag/5.2.0)

**Tools**

No one of the tools in the arsenal is able to detect the vulnerability. 

**Patterns**:

1. [Function Declared and Immediately Executed](https://github.com/enferas/TestabilityTarpits/tree/main/JS/TestabilityPatterns/13_function_declared_immediately_executed)
2. [Callback Function](https://github.com/enferas/TestabilityTarpits/tree/main/JS/TestabilityPatterns/6_callback_function)
3. [getAttribute](https://github.com/enferas/TestabilityTarpits/tree/main/JS/TestabilityPatterns/83_getAttribute)
4. [Asynchronous Event Handler](https://github.com/enferas/TestabilityTarpits/tree/main/JS/TestabilityPatterns/78_asynchronous_event_handler)

**Explain code**:

The sinks and the source are both in the file **plugins/video-embed-ls.video-embed.js**

```js
function embedVimeoIframe(e){
    var elem = e.currentTarget;
    var id = elem.getAttribute('data-vimeo'); //SOURCE
    var vimeoParams = elem.getAttribute('data-vimeoparams') || ''; //SOURCE
    if(vimeoParams && !regAmp.test(vimeoParams)){
       vimeoParams = '&'+ vimeoParams;
    }
    ...
    elem.innerHTML = '<iframe src="' + (vimeoIframe.replace(regId, id)) + vimeoParams +'" ' +
        'frameborder="0" allowfullscreen="" width="640" height="390"></iframe>'; //SINK 
    ...
}

function embedYoutubeIframe(e){
   var elem = e.currentTarget;
   var id = elem.getAttribute('data-youtube'); //SOURCE
   var youtubeParams = elem.getAttribute('data-ytparams') || ''; //SOURCE
   if(youtubeParams && !regAmp.test(youtubeParams)){
      youtubeParams = '&'+ youtubeParams;
   }
   ...
   elem.innerHTML = '<iframe src="' + (youtubeIframe.replace(regId, id)) + youtubeParams +'" ' +
      'frameborder="0" allowfullscreen="" width="640" height="390"></iframe>';  //SINK
   ...
}
// called by functions embedVimeoImg and embedYoutubeImg as event handlers for 'click' events:
function embedVimeoImg(id, elem){
   getJSON(vimeoApi.replace(regId, id), function(data){
      if(data && data.thumbnail_url){
         elem.style.backgroundImage = 'url('+ data.thumbnail_url +')';
      }
   });
   elem.addEventListener('click', embedVimeoIframe);
}

function embedYoutubeImg(id, elem){
   var ytImg = elem.getAttribute('data-thumb-size') || lazySizes.cfg.ytThumb || 'hqdefault';
   elem.style.backgroundImage = 'url('+ youtubeImg.replace(regId, id).replace(regYtImg, ytImg) +')';
   elem.addEventListener('click', embedYoutubeIframe);
}
    
// from:
document.addEventListener('lazybeforeunveil', function(e){
   if(e.detail.instance != lazySizes){return;}
   var elem = e.target;
   var youtube = elem.getAttribute('data-youtube');
   var vimeo = elem.getAttribute('data-vimeo');
   if(youtube && elem){
      embedYoutubeImg(youtube, elem);
   }
   if(vimeo && elem){
      embedVimeoImg(vimeo, elem);
   }
});
```

All these functions are scoped inside a function declared and immediately executed:

```js
(function(window, factory) {
	...
}(typeof window != 'undefined' ?
	window : 0, function(window, document, lazySizes) {
    ...
```

**Refactoring**:

- **Function Declared and Immediately Executed** (P13) is transformed in a classic function definition, which is then called. This transformation maintains the code semantic and it is type **T1**.

```js
function funcDecEx(window) {
	...
}

if(typeof window != 'undefined'){
	funcDecEx(window);
}else{
	funcDecEx(0);
}
```

- **Callback Function** (P6): function is not passed as argument, it's defined externally in classic way and call then in the code. This transformation maintains the code semantic and it is type **T1**.

```js
function callback1(window, document, lazySizes) {
    ...
}
    
function funcDecEx(window) {
	...
    callback1(window.lazySizes);
    ...
}
```

- **getAttribute** (P83) function is changed with getElementById().value in order to not impact on the vulnerability type. Transformation is type **T1**.

```js
// Before:
var id = elem.getAttribute('data-youtube');
// After transformation:
var id = elem.getElementById('data-vimeo').value;
```

- **Asynchronous Event Handler** (P78): the event handler function is called in synchronous way where the add of event listener is performed. This transformation changes the code semantic and therefore is type **T2**.

```js
// Before:
elem.addEventListener('click', embedVimeoIframe);
// After transformation:
embedVimeoIframe();
```

After the tarpits transformations on the code, Comm_2 is able to detect the vulnerabilities explained in the CVE.
