**Project**: Bakeshop Online Ordering System

**Vulnerability Type**: XSS

**CVE link**: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-35309

## Project info

- https://www.sourcecodester.com/tags/ordering-management-system-php
- Latest vulnerable version downloaded: 15/04/2021

- Figures:
  - LOC (PHP): 9863
  - number of files (PHP): 98
  - LOC (JS): 25487
  - number of files (JS): 25

## Patterns

1. Pattern 1 - [P57: JS redirect](https://github.com/enferas/TestabilityTarpits/tree/main/PHP/TestabilityPatterns/57_JS_redirect)  (T2 transformation)
```php
echo "<script> window.location='{$location}' </script>";	
```

## Tools

- _Comm_1_:
  - no discovery of the vulnerability

## The vulnerability on the code

The data flow for this vulnerability connects:
- source: `$_POST['CATEGORY']`, file `admin/category/controller.php`, line 40 (function `doInsert`)
- sinks: `echo  '....'.$_SESSION['message']`, file `include/session.php` lines 60, 63, and 66

Hereafter the steps of the data flow:

1. The source goes in function `message` that just store the message content into the session object, namely `$_SESSION['message']`
```php
// In the file admin/category/controller.php (doInsert Function)
message("New [". $_POST['CATEGORY'] ."] created successfully!", "success");
```

```php
//In the file include/session.php
function message($msg="", $msgtype="") {
   $_SESSION['message'] = $msg;
}
```

2. The code will then continue and execute the function `redirect` that will dynamically start executing the file passed as argument, i.e., `index.php`. Notice that is doing that using the JavaScript `window.location` function.
```php
// In the file admin/category/controller.php (doInsert Function)
redirect("index.php");
```

```php
// In the file include/function.php
function redirect($location=Null){
    if($location!=Null){
        echo "<script>
                window.location='{$location}'
            </script>";	
    }else{
        echo 'error location';
    }       
}
```

3. We are now in `index.php`, that at some point will start executing `../theme/templates.php` that, in turns, will execute function `check_message()` defined in `include/session.php`
```php
// In the file index.php
require_once ("../theme/templates.php");
```

```php
// In the file admin/theme/templates.php
check_message();
```

4. Here is where the sink takes place: the content of `$_SESSION['message']`, that comprises the source, is printed 
```php
//In the file include/session.php
function check_message(){
// some code
echo  '<label class="alert alert-info" style="width:100%;padding:5px;">'. $_SESSION['message'] . '</label>';
// some code
}
```

## Transformations

Two transformations need to be done to enable the tool in detecting the vulnerability.

1. JavaScript dynamic code in PHP. 
```php
function redirect($location=Null){
    if($location!=Null){
        echo "<script>
                window.location='{$location}'
            </script>";	
    }else{
        echo 'error location';
    }       
}
```
  - ...is transformed into:
```php
function redirect($location=Null){
    if($location!=Null){
        include({$location});
    }else{
        echo 'error location';
    }       
}
```

2. the second transformation deals with the dynamicity of `$location` variable parameter. For each occurrence of function invocation `redirect` with a constant parameter, a specific redirect function variant is created. For instance, in our example `redirect("index.php")` is transformed into:

```php
redirect_1()
// some code
function redirect_1(){
    $location = "index.php";
    if($location!=Null){
        include({$location});
    }else{
        echo 'error location';
    }       
}
```

Overall: This transformation will change the semantic of the project.
Because in JS redirect we can connect between the two pages only with the session.
While with include all the variables are connected between the two pages.

## Results

There are 140 `redirect` occurrences in the project and we transform all of them.

**Discovery**:

**4 NEW Vulnerabilities discovered after transformation**

For each source there are 3 different sinks. Then there are 15 reports and all of them are XSS vulnerabilities.

```php

// admin/category/controller.php doEdit Function
message("[". $_POST['CATEGORY'] ."] has been updated!", "success");

// admin/orders/controller.php doInsert Function
message("New [". $_POST['PRODUCTNAME'] ."] created successfully!", "success");

// admin/user/controller.php doInsert Function
message("New [". $_POST['U_NAME'] ."] created successfully!", "success");

// admin/user/controller.php doEdit Function
message("[". $_POST['U_NAME'] ."] has been updated!", "success");
```