**Project**: MantisBT 

**Version**: 1.2.7

**Vulnerability Type**: File injection

**Vulnerability Description**: Directory traversal vulnerability in bug_actiongroup_ext_page.php in MantisBT before 1.2.8 allows remote attackers to include and execute arbitrary local files via a .. (dot dot) in the action parameter, related to bug_actiongroup_page.php.

**Vulnerability Patch**: https://github.com/mantisbt/mantisbt/commit/5b93161f3ece2f73410c296fed8522f6475d273d

**Link to the vulnerable project**: https://github.com/mantisbt/mantisbt/tree/release-1.2.7

**Tools**

_Comm_1_  didn't discovered the vulnerability.

1. [P80 - callback function](https://github.com/GiuliCler/testability_tarpits/tree/main/PHP/Testability_Patterns/80_callback_functions) D1  (T1 transformation)

**Explain code**:

```php

function gpc_get( $p_var_name, $p_default = null ) {
	if( isset( $_POST[$p_var_name] ) ) {
		$t_result = gpc_strip_slashes( $_POST[$p_var_name] );
	} else if( isset( $_GET[$p_var_name] ) ) {
		$t_result = gpc_strip_slashes( $_GET[$p_var_name] );
	}
	else if( func_num_args() > 1 ) {
		# check for a default passed in (allowing null)
		$t_result = $p_default;
	} else {
		error_parameters( $p_var_name );
		trigger_error( ERROR_GPC_VAR_NOT_FOUND, ERROR );
		$t_result = null;
	}

	return $t_result;
}

function gpc_get_string( $p_var_name, $p_default = null ) {

    # Don't pass along a default unless one was given to us
    #  otherwise we prevent an error being triggered
    $args = func_get_args();
    // The dynamic call
    $t_result = call_user_func_array( 'gpc_get', $args );


    if( is_array( $t_result ) ) {
        error_parameters( $p_var_name );
        trigger_error( ERROR_GPC_ARRAY_UNEXPECTED, ERROR );
    }

    return $t_result;
}

```

In file **bug_actiongroup_ext.php**

```php
$f_action = gpc_get_string( 'action' );

$t_action_include_file = 'bug_actiongroup_' . $f_action . '_inc.php';

require_once( dirname( __FILE__ ) . DIRECTORY_SEPARATOR . $t_action_include_file );
```

**Refactoring**

Change the dynamic call to static call.

```php

// old line
$t_result = call_user_func_array( 'gpc_get', $args );

// new line
$t_result =  gpc_get($args);
```

**The whole project**
We found 58 callback functions in this projects.

We found 4 different usages for the call back function.
Note: all the examples are from the MantisBT project.

```php
// 1. The called function will be controlled by the user
// gpc_get_string function will return input from the user $_GET
// D3 category
$f_entrypoint = gpc_get_string( 'entrypoint' );
$t_function = 'xmlhttprequest_' . $f_entrypoint;
call_user_func( $t_function );

// 2. The different functions can be called
// It depends on the call of the function event_callback
// D4 category
function event_callback( $p_event, $p_callback, $p_plugin, $p_params = null ) {
	//some code
	$t_value = call_user_func_array( $p_callback, array_merge( array( $p_event ), $p_params ) );
	//some code
}
function event_type_execute( $p_event, $p_callbacks, $p_params ) {
	foreach( $p_callbacks as $t_plugin => $t_callbacks ) {
		foreach( $t_callbacks as $t_callback ) {
			event_callback( $p_event, $t_callback, $t_plugin, $p_params );
		}
	}
}

// 3. We can know the value of the variable by constant propagation
// D2 category
$fn = 'ibase_execute';
$ret = call_user_func_array($fn,$fnarr);
// or
if( $upgrade[$i][0] == 'InsertData' ) {
    $sqlarray = call_user_func_array( $upgrade[$i][0], $upgrade[$i][1] );
}

// 4. Direct call
D1 category
$t_result = call_user_func_array( 'gpc_get', $args );
// or
$ret = call_user_func_array('mysqli_stmt_bind_param',$fnarr);
// or call a method in the parent
return call_user_func_array(array($this,'parent::Concat'), $args); 
```

The D4 category need the help from the developer to tell us which functions can be called then we need to add all the possible functions (we can add the calls with if and else then the semantic will ne be changed).
```php
call_user_func($func);
// change to 
if($func=="Func1") Func1();
if($func=="Func2") Func2();
// and so on ...
```

while the last two usages we can change that automatically without changing the semantic of the project.

In this project we have 58 callback functions. 41 from the D4 category and 17 from D1, D2 and D3 categories.

We transform the 17 cases and run the scan with Comm_1 before and after the transformation.

**Discovery**

This project is raising the importance of our patterns because one pattern was the bottleneck for the static tool. The function gpc\_get\_string is called 310 times and this function always will return a source and the tool was not able to recognize that. After this transformation, the tool was able to give 151 new alerts. And after checking these alerts manually we discovered 28 XSS, 18 File injection, and 3 Code injection vulnerabilities. Most of them are solved in the latest version and we were able to report for undiscovered vulnerabilities under the \textbf{CVE-2021-33557}.
