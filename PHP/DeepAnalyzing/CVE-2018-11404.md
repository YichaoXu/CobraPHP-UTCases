**This case from Exploit DB**
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11404

**Project**: Dmainmod

**Version**: 4.09.03

**Vulnerability Type**: XSS

**Vulnerability Description**: DomainMod v4.09.03 has XSS via the assets/edit/ssl-provider-account.php sslpaid parameter.

**Vulnerability Patch**: https://github.com/domainmod/domainmod/commit/f10aefdd8e992a41c356e5e3ae9d22162149a3ff

**Link to the vulnerable project**: https://github.com/domainmod/domainmod/tree/v4.09.03

**Tools**

_Comm_1_  didn't discovere the vulnerability.

**Patters**:
1. [P74 - Dirname function](https://github.com/enferas/TestabilityTarpits/tree/main/PHP/TestabilityPatterns/74_dirname) (T1 transformation)

2. [P79 - Dynamic include](https://github.com/enferas/TestabilityTarpits/tree/main/PHP/TestabilityPatterns/79_dynamic_include) D1 (T1 transformation)

3. [P75 - Buffer](https://github.com/enferas/TestabilityTarpits/tree/main/PHP/TestabilityPatterns/75_buffer) (T1 transformation)

**Explain code**:

In the file **assets/edit/ssl-provider-account.php**
```php

// The source
$sslpaid = $_GET['sslpaid'];

// some code

$_SESSION['s_message_danger'] .= "Are you sure you want to delete this SSL Account?<BR><BR><a href=\"ssl-provider-account.php?sslpaid=" . $sslpaid . "&really_del=1\">YES, REALLY DELETE THIS SSL PROVIDER ACCOUNT</a><BR>";

// some code

<?php require_once DIR_INC . '/layout/header.inc.php'; ?>
```

In the file "_includes/layout/header.inc.php"

```php
if ($_SESSION['s_message_danger'] != "") {
    echo $system->showMessageDanger($_SESSION['s_message_danger']);
    unset($_SESSION['s_message_danger']);
}
```

and the method showMessageDanger in file "System.php"

```php
public function showMessageDanger($result_message){
    ob_start(); ?>
    <BR>
    <div class="alert alert-danger alert-dismissible">
        <h4><i class="icon fa fa-exclamation-circle"></i> Alert!</h4>
        <?php echo $result_message; ?>
    </div><?php
    return ob_get_clean();
}
```

The third transformation is to delete the dirname.

```php
define('DIR_ROOT', dirname(dirname(__FILE__)));
define('DIR_INC', DIR_ROOT . '/_includes');

include(DIR_INC . "/ttt/b.php");
```

Transformed to:
```php
define('DIR_INC', '../_includes');

include(DIR_INC . "/ttt/b.php");
```

## Transformation

The main problem that there are 1700 include in this project. Then the tool was not able to process the included files and the tool report 0 alerts for the project.

We write a script to copy the content of the file instead of including file.

For example:
```php
\\ File 1 (f1.php)
$x = "abc";
include("f2.php");

\\file 2(f2.php)
$y = "def";
echo $x.$y;
```

Transformed to:
```php
\\ File 1 (f1.php)
$x = "abc";
$y = "def";
echo $x.$y;
```

The second transformation that we delete the buffer.
```php
public function showMessageDanger($result_message){
    ob_start(); ?>
    <BR>
    <div class="alert alert-danger alert-dismissible">
        <h4><i class="icon fa fa-exclamation-circle"></i> Alert!</h4>
        <?php echo $result_message; ?>
    </div><?php
    return ob_get_clean();
}
```

Transformed to:

```php
public function showMessageDanger($result_message){
    str = '<BR>
    <div class="alert alert-danger alert-dismissible">
        <h4><i class="icon fa fa-exclamation-circle"></i> Alert!</h4>
        '. $result_message .'
    </div>';
    return str;
}
```

## Discovery

We find 4 undiscovered vulnerabilities and the developer confirm the vulnerabilities.

### XSS 1
```
1.           The source controlled by the attacker (file admin/users/edit.php, line 58): `$new_currency = $_POST['new_currency'];`
2.           That variable is then stored in the session object ((file admin/users/edit.php, line 220): `$_SESSION['s_default_currency'] = $new_currency;`
3.           Finally that session object member is printed without sanitization (file _includes/layout/header.inc.php, line 152): `<?php echo $_SESSION['s_default_currency']; ?>`
Note: The attacker cannot control the value of `new_currency` from the web interface, but he/she can control it via the HTTP request that can be edited and sent by e.g., Postman.
```

### XSS 2
```
Same steps than XSS 1, here the source is (file admin/users/edit.php, line 59): `$new_timezone = $_POST['new_timezone'];`
```

### XSS 3
```
1.           The source controlled by the attacker (file segments/edit.php, line 49):  `$segid = $_GET['segid'];`
2.           Input propagation (file segments/edit.php, Line 311): `$layout->deleteButton(_('Segment'), $new_name, 'edit.php?segid=' . $segid . '&del=1');`
3.           Initiating the printing where the input was previously propagated into the variable `$url` in the function header (file classes/DomainMOD/Layout.php, line 139): `echo $this->modal(_('Delete') . ' ' . $item_type, $item_name, $url, strtoupper(_('Cancel')), strtoupper(_('Yes, Delete')));`
4.           Attacker controlled input is printed (file classes/DomainMOD/Layout.php, line 169): `<a href="<?php echo $url; ?>"><type="button" class="btn btn-danger"><?php echo $right_button; ?></button></a>`
```

### XSS 4
```
In the file assets/ssl-provider-fees.php
a.           the source controlled by the attacker, Line 43, `$sslpid = $_GET['sslpid'];`
b.           the source is stored temp_all_missing_fees variable, in Line 138,
`$temp_all_missing_fees = $temp_all_missing_fees .= "<a href=\"add/ssl-provider-fee.php?sslpid=" . $sslpid . "&type_id=" . $row2->id . "\">" . $row2->type . "</a>, ";`
c. last two chars of temp_all_missing_fees are deleted, Line 143,
`$all_missing_fees = substr($temp_all_missing_fees, 0, -2); ?>`
d.           the source is printed, Line 144,
`<strong><?php echo $all_missing_fees; ?></strong><BR>`
```