**Project**: OSClass

**Version**: 2.3.4

**Vulnerability Type**: XSS

**Vulnerability Description**: Multiple cross-site scripting (XSS) vulnerabilities in the getParam function in oc-includes/osclass/core/Params.php in OSClass before 2.3.5 allow remote attackers to inject arbitrary web script or HTML via the (1) sCity, (2) sPattern, (3) sPriceMax, and (4) sPriceMin parameters in a search action to index.php.

**Vulnerability Patch**: https://github.com/osclass/OSClass/commit/ff7ef8a97301aaaf6a97fe46c2c27981a86b4e2f#diff-73

**Link to the vulnerable project**: https://github.com/osclass/Osclass/releases/tag/v2.3.4

**Tools **

_Comm_1_ didn't discover the vulnerability.

**Patters**:
1. [P79 - Dynamic include](https://github.com/GiuliCler/testability_tarpits/tree/main/PHP/Testability_Patterns/79_dynamic_include) D2  (T1 transformation)

2. [P83 - Array variable key](https://github.com/GiuliCler/testability_tarpits/tree/main/PHP/Testability_Patterns/83_array_variable_key) D2  (T2 transformation)

3. [P49 - One instance of class](https://github.com/GiuliCler/testability_tarpits/tree/main/PHP/Testability_Patterns/49_static_instance)  (T2 transformation)

**Explain code**:

The sink in **oc-includes\osclass\gui\search.php**
```php
<input type="text" id="priceMax" name="sPriceMax" value="<?php echo osc_search_price_max() ; ?>" size="6" maxlength="6" />
```

The function in file **oc-includes\osclass\helpers\hsearch.php**
```php
function osc_search_price_max() {
    return View::newInstance()->_get('search_price_max');
}
```

The class View in **oc-includes\osclass\core\View.php**
```php
// array used to save the varibles for set and get
private $aExported ;
private $aCurrent ;
// only one instance of this class
private static $instance ;

public static function newInstance()
{
    if(!self::$instance instanceof self) {
        self::$instance = new self ;
    }
    return self::$instance ;
}

function _exportVariableToView($key, $value){
      $this->aExported[$key] = $value ;
}

function _get($key)
{
    if ($this->_exists($key)) {
        return($this->aExported[$key]) ;
    } else {
        return '' ;
    }
}

```

The source in file **search.php**
```php
$p_sPriceMax  = Params::getParam('sPriceMax');

$this->_exportVariableToView('search_price_max', $p_sPriceMax);
```

The function _exportVariableToView is in **oc-includes\osclass\core\BaseModel.php**
```php
function _exportVariableToView($key, $value){
    View::newInstance()->_exportVariableToView($key, $value) ;
}
```

The function getParam in **oc-includes\osclass\core\Params.php**
```php
static function getParam($param, $htmlencode = false)
{
    if ($param == "") return '' ;
    if (!isset($_REQUEST[$param])) return '' ;

    $value = $_REQUEST[$param];
    if (!is_array($value)) {
        if ($htmlencode) {
            return htmlspecialchars(stripslashes($value), ENT_QUOTES);
        }
    }

    if(get_magic_quotes_gpc()) {
        $value = strip_slashes_extended($value);
    }

    return ($value);
}
```

So in this project there is one static instance of View. This object has an array which will save the variables. The function _exportVariableToView will be used to set elements in the array and the function _get to get elements from this array.

The connection between the set and the get is with the dynamic include in the file **search.php**
```php
$this->doView('search.php');

function doView($file){
    osc_current_web_theme_path($file);
}
```

Then the function osc_current_web_theme_path will include the file **osclass/gui/search.php**

**Refactoring**

1. Change the dynamic include to static include in **search.php**.

```php

// The old line
$this->doView('search.php');

function doView($file){
    osc_current_web_theme_path($file);
}

// the new line 
require "oc-includes/osclass/gui/search.php";
```

2. Change the set of the variable in the array in the class View to Global variable.
```php
// The old line
$this->_exportVariableToView('search_price_max', $p_sPriceMax);
// The new line
$GLOBALS["View_search_price_max"] = $p_sPriceMax;
```

3. Change the get of the variable from the array in class View to Global Variable.
```php
// The old line
return View::newInstance()->_get('search_price_max');

// The new line
return $GLOBALS["View_search_price_max"];

```

## Statistics from Osclass

The function _exportVariableToView is used 212 times in the projects. For all the call, the static is not a variable. Then we change all of them to be globals.
```php
// Example
View::newInstance()->_exportVariableToView('item', $item);
```
The function get in the View class is called 46 times. 45 times the key is not a variable
```php
// Example
$user = View::newInstance()->_get('user') ;
```

Only one time the key is a variable in the function \_\_get.
```php
function __get($key) {
     return View::newInstance()->_get($key) ;
}
```
This function is called 78 times and all the passed arguments are not variables.
For that we change all the called of this function.
```php
// The old line
$category   = __get("category");

// The new line
$category   = $GLOBALS["search_price_max"];
```

Similar to these two functions in the class View, we have the functions set, get, setForm, getForm, setMessage, getMessage in the class Session. We changed all of them in the same way.

set called 30 times.

setForm called called 35 times.

setMessage called 4 times.

get called 41 times.

getForm called 94 times.

getMessage called 2 times.

For the dynamic include, the function osc_current_web_theme_path is called 149 times.

11 times, the argument is a variable then we checked and change manually.
```php
// Example
$this->doView('user-public-profile.php') ;

function doView($file) {
    osc_current_web_theme_path($file) 
}

// Change to
require 'oc-includes\osclass\gui\user-public-profile.php';
```

138 times, the argument is not a variable then we change automatically.
```php
osc_current_web_theme_path('head.php') ;
// change to
require 'oc-includes\osclass\gui\head.php';
```